{% extends "base.html" %}
{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <div>
        <h2 style="margin: 0; color: #2c3e50;">#{{ team.number }} - {{ team.name }}</h2>
        <p style="margin: 5px 0 0; color: #7f8c8d;">ğŸ“ {{ team.city }}, {{ team.state }} | ğŸ“ˆ OPR: {{ "%.2f"|format(team.opr or 0) }}</p>
    </div>
    <button onclick="document.getElementById('interview-section').scrollIntoView({behavior: 'smooth'})" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">ğŸ“ Go to Interview</button>
</div>

<div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px;">
    
    <div>
        <section style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="margin-top: 0;">Autonomous Strategy Notebook</h3>
            <div style="position: relative; display: inline-block; width: 100%;">
                <canvas id="scoutCanvas" width="600" height="400" style="border: 2px solid #555; background: #eee url('/static/field_bg.png'); background-size: cover; border-radius: 8px; cursor: crosshair; touch-action: none; width: 100%; max-width: 600px;"></canvas>
                <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="setTool('pen')" style="padding: 8px 15px;">ğŸ–Šï¸ Pen</button>
                    <button onclick="setTool('eraser')" style="padding: 8px 15px;">ğŸ§½ Eraser</button>
                    <input type="color" id="colorPicker" value="#ff0000" style="height: 35px; width: 50px; border: none;">
                    <button onclick="clearCanvas()" style="padding: 8px 15px;">ğŸ—‘ï¸ Clear</button>
                    <button id="saveBtn" onclick="saveDrawing()" style="background-color: #2ecc71; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: auto;">ğŸ’¾ Save Drawing</button>
                </div>
            </div>
        </section>

        <section id="interview-section" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0;">Team Interview (2025 DECODE Season)</h3>
            <form action="/save_interview" method="POST">
                <input type="hidden" name="team_num" value="{{ team.number }}">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    {% set questions = [
                        "Consistent Auto?", "Preloaded Element?", "Park in Auto?", "High Basket Capable?",
                        "Sample to Net?", "Multi-Sample Auto?", "AprilTag Alignment?", "Drivetrain: 4-Motor?",
                        "Drivetrain: Mecanum?", "Intake: Active Roller?", "Intake: Claw/Grabber?", "Outtake: Slides?",
                        "Outtake: Linkage?", "Can score High?", "Can score Mid?", "Can score Low?",
                        "Holds 2 Samples?", "Anti-Tip Mechanism?", "Fast Cycle Time?", "Color Sensor used?",
                        "Endgame: Level 1 Ascent?", "Endgame: Level 2 Ascent?", "Endgame: Level 3 Ascent?", 
                        "Endgame: Fast Ascent?", "Submersible Expert?"
                    ] %}

                    {# Parse existing JSON answers if they exist #}
                    {% set current_answers = interview.answers|from_json if interview and interview.answers else {} %}

                    {% for q in questions %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
                        <span style="font-size: 0.9em; font-weight: 500;">{{ q }}</span>
                        <input type="hidden" name="q{{ loop.index }}_text" value="{{ q }}">
                        <label class="switch">
                            <input type="checkbox" name="q{{ loop.index }}" value="Yes" 
                                   {% if current_answers.get(q) == 'Yes' %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div style="margin-top: 20px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">General Scouting Notes:</label>
                    <textarea name="notes" rows="4" style="width: 100%; border-radius: 8px; border: 1px solid #ddd; padding: 10px; font-family: inherit;">{{ interview.notes if interview else '' }}</textarea>
                </div>
                
                <button type="submit" style="margin-top: 20px; width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em;">ğŸ’¾ Save All Interview Data</button>
            </form>
        </section>
    </div>

    <div>
        <section style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 20px;">
            <h3 style="margin-top: 0;">Robot Photo</h3>
            <div style="width: 100%; aspect-ratio: 1/1; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 10px; background: #fafafa;">
                {% if team.photo_path %}
                    <img src="/static/uploads/{{ team.photo_path }}" 
                         onerror="this.src='/static/logo.png';" 
                         style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <img src="/static/logo.png" style="width: 70%; opacity: 0.5;">
                {% endif %}
            </div>
            
            <form action="/upload_photo" method="POST" enctype="multipart/form-data" style="margin-top: 15px;">
                <input type="hidden" name="team_num" value="{{ team.number }}">
                <input type="file" name="photo" accept="image/*" capture="environment" style="width: 100%; margin-bottom: 10px; font-size: 0.8em;">
                <button type="submit" style="width: 100%; background: #34495e; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ğŸ“¤ Upload Photo</button>
            </form>
        </section>
    </div>
</div>

<style>
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #27ae60; }
    input:checked + .slider:before { transform: translateX(20px); }
    hr { border: 0; border-top: 1px solid #eee; margin: 30px 0; }
</style>

<script>
    const canvas = document.getElementById('scoutCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let mode = 'pen';

    // Set canvas internal resolution to match displayed size
    function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        // Only set if size is significantly different to prevent clearing on scroll
    }

    {% if drawing %}
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = "{{ drawing.image_data|safe }}";
    {% endif %}

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stop);
    canvas.addEventListener('touchstart', (e) => { start(e.touches[0]); e.preventDefault(); }, {passive: false});
    canvas.addEventListener('touchmove', (e) => { draw(e.touches[0]); e.preventDefault(); }, {passive: false});
    canvas.addEventListener('touchend', stop);

    function start(e) { drawing = true; draw(e); }
    function stop() { drawing = false; ctx.beginPath(); }

    function setTool(t) { mode = t; }
    function clearCanvas() { if(confirm("Clear this drawing?")) ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function draw(e) {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;

        ctx.lineWidth = mode === 'eraser' ? 25 : 4;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        if (mode === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out';
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = document.getElementById('colorPicker').value;
        }

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    async function saveDrawing() {
        const btn = document.getElementById('saveBtn');
        const oldText = btn.innerText;
        btn.innerText = "Saving...";
        const dataURL = canvas.toDataURL();
        try {
            await fetch('/save_drawing', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ team_num: "{{ team.number }}", image: dataURL })
            });
            btn.innerText = "âœ… Saved!";
        } catch (e) {
            btn.innerText = "âŒ Error";
        }
        setTimeout(() => btn.innerText = oldText, 2000);
    }
</script>
{% endblock %}